<!doctype html>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="{{url_for('static', filename='d3.js')}}"></script>

<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

<title>Kredyty</title>

<style>
    body {
        display: flex;
        min-height: 100vh;
        flex-direction: column;
    }

    #wrapper {
        flex: 1;
    }


    .filler {
        position: absolute;
        left: 0;
        right: 0;
        border-bottom: 1px dashed #333;
        height: 50%;
    }

    .naklejka {
        background: white;
        float: left;
        margin-right: 20px;
        padding-right: 4px;
        position: relative;
    }

    .tekst {
        background: white;
        padding-left: 4px;
        position: relative;
    }



    .kontainer {
        position: relative;
        text-align: right;
        white-space: nowrap;
    }
</style>



<nav class="navbar is-info" role="navigation" aria-label="main navigation" id="nav-bar">
    <div class="navbar-brand">
        <p class="navbar-item">
            <img src="{{ url_for('static', filename='logo.png')}}" width="40" height="40">
        </p>

        <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
    </div>



    <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">

            <p class="navbar-item">
                Kalkulator RRSO
            </p>



        </div>

        <div class="navbar-end">
            <div class="navbar-item">
                <div class="buttons">
                    {% if current_user.is_authenticated %}
                    <a class="button is-light" href="{{ url_for('admin_bp.logout') }}">
                        {{current_user.name}} - Wyloguj
                    </a>
                    {%- else %}

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</nav>




<div id="wrapper">
    <section class="content">



        <div class="content">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            {% if category == 'error' %}
            <div class="alert">{{ message }}</div>
            {% else %}
            <div class="notification is-success">{{ message }}</div>
            {% endif %}
            {% endfor %}
            {% endif %}
            {% endwith %}

        </div>




        <div class="block">
            <div class="container">

                <form id="kredyt-form" action="{{ url_for('rrso.rrso_main') }}" method="POST">

                    <div class="field is-horizontal">
                        <div class="field-body">

                            <div class="field is-narrow">
                                <label class="label">Data umowy</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="DD/MM/YYYY" name="data_umowy">
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Całkowita kwota kredytu</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Kredyt (PLN)" name="calkowita_kwota">
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Kwota udzielonego kredytu</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Kredyt + prowizja (PLN)"
                                        name="udzielona_kwota">
                                </div>
                            </div>


                        </div>
                    </div>


                    <div class="field is-horizontal">
                        <div class="field-body">
                            <div class="field is-narrow">
                                <label class="label">Liczba rat miesięcznych</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="okresy" name="okresy">
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Rodzaj rat</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="rodzaj_rat">
                                            <option value="stale" selected>stałe</option>
                                            <option value="malejace">malejące</option>
                                        </select>
                                    </div>
                                </div>
                            </div>



                        </div>
                    </div>

                    <div class="field is-horizontal">
                        <div class="field-body">

                            <div class="field is-narrow">
                                <label class="label">Oprocentowanie pożyczki</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="oprocentowanie_pozyczki">
                                            <option value="stale" selected>stałe</option>
                                            <option value="zmienne">zmienne</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Wysokość oprocentowania stałego</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="stopa opr. stałego %"
                                        name="oprocentowanie_stale">
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Rodzaj wiboru</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select name="rodzaj_wiboru" disabled>
                                            <option value="3M" selected>Wibor 3M</option>
                                            <option value="6M">Wibor 6M</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-body">

                            <div class="field is-narrow">
                                <label class="label">Marża</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="marża (%)" name="marza">
                                </div>
                            </div>

                            <div class="field is-narrow">
                                <label class="label">Pozaodsetkowe koszty kredytu</label>
                                <div class="control">
                                    <input class="input" type="text" placeholder="Ile? (PLN)"
                                        name="pozaodsetkowe_koszty">
                                </div>
                            </div>

                        </div>
                    </div>


                    <div class="field is-narrow">
                        <div class="control">
                            <button type="submit" class="button is-primary" id="idGuzik">
                                Oblicz
                            </button>
                        </div>
                    </div>





                </form>

            </div>
        </div>




    </section>

    <section id="wynik" class="is-hidden">
        <div class="container">

            <div class="block">
                <div class="columns">
                    <div class="column">
                        <ul class="list-group list-group-flush">
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Data umowy</span><span
                                        class="tekst" id="data_umowy"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Całkowita kwota kredytu</span><span
                                        class="tekst" id="calkowita_kwota"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Kwota udzielonego
                                        kredytu</span><span class="tekst" id="kwota_udzielonego"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Liczba rat</span><span
                                        class="tekst" id="okresy"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Rodzaj rat</span></span><span
                                        class="tekst" id="rodzaj_rat"></span>
                                </div>
                            </li>

                        </ul>
                    </div>
                    <div class="column">
                        <ul>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Rodzaj
                                        oprocentowania</span></span><span class="tekst"
                                        id="rodzaj_oprocentowania"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Wysokość oprocentowania
                                        stałego</span></span><span class="tekst" id="oprocentowanie_stale"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Rodzaj wiboru</span></span><span
                                        class="tekst" id="rodzaj_wiboru"></span>
                                </div>
                            </li>
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Marża</span></span><span
                                        class="tekst" id="marza"></span>
                                </div>
                            </li>

                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Pozaodsetkowe koszty
                                        kredytu</span></span><span class="tekst" id="pozaodsetkowe_koszty"></span>
                                </div>
                            </li>
                        </ul>
                    </div>

                </div>
            </div>


            <div class="block top-buffer">
                <div class="columns">
                    <div class="column">
                        <ul class="list-group list-group-flush">
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Prowizja</span><span
                                        class="tekst" id="prowizja"></span>
                                </div>
                            </li>

                        </ul>
                    </div>
                    <div class="column">
                        <ul class="list-group list-group-flush">
                            <li>
                                <div class="kontainer">
                                    <div class="filler"></div><span class="naklejka">Całkowite oprocentowanie</span><span
                                        class="tekst" id="calkowite_oprocentowanie"></span>
                                </div>
                            </li>

                        </ul>

                    </div>

                </div>
            </div>
        </div>
        <div class="container"><div class="block"></div></div>
        <div class="container">
            <div class="block">
                <nav class="level top-buffer">
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">RRSO bez prowizji</p>
                            <p class="title" id="rrso_bez_p"></p>
                        </div>
                    </div>
                    <div class="level-item has-text-centered">
                        <div>
                            <p class="heading">RRSO z prowizją</p>
                            <p class="title" id="rrso_z_p"></p>
                        </div>
                    </div>
                </nav>
            </div>
        </div>
    </section>

</div>

<footer class="footer">
    <div class="content has-text-centered">

        Kalkulator RRSO 2023

    </div>
</footer>

<script type="module">
    console.log('by name')
    console.log(document.getElementsByName("oprocentowanie_pozyczki")[0].value)

    document.getElementsByName("oprocentowanie_pozyczki")[0].addEventListener("change",
        function () {

            if (this.value == 'zmienne') {
                document.getElementsByName("oprocentowanie_stale")[0].disabled = true;
                document.getElementsByName("rodzaj_wiboru")[0].disabled = false;

            } else {
                document.getElementsByName("oprocentowanie_stale")[0].disabled = false;
                document.getElementsByName("rodzaj_wiboru")[0].disabled = true;

            }
            console.log(this.value)

        });

    // read request object as json string

    const dane = JSON.parse('{{ request.form | tojson | safe}}');
    console.log('dane')
    console.log(dane)


    // check if dane is not empty dict


    if (Object.keys(dane).length > 0) {

        if (dane['oprocentowanie_pozyczki'] == 'zmienne') {
            document.getElementsByName("oprocentowanie_stale")[0].disabled = true;
            document.getElementsByName("rodzaj_wiboru")[0].disabled = false;

        } else {
            document.getElementsByName("oprocentowanie_stale")[0].disabled = false;
            document.getElementsByName("rodzaj_wiboru")[0].disabled = true;

        }


        document.getElementsByName("data_umowy")[0].value = dane['data_umowy'];

        document.getElementsByName("calkowita_kwota")[0].value = dane['calkowita_kwota'];
        document.getElementsByName("udzielona_kwota")[0].value = dane['udzielona_kwota'];

        document.getElementsByName("okresy")[0].value = dane['okresy'];
        document.getElementsByName("rodzaj_rat")[0].value = dane['rodzaj_rat'];

        document.getElementsByName("oprocentowanie_pozyczki")[0].value = dane['oprocentowanie_pozyczki'];

        if ('oprocentowanie_stale' in dane) {
            document.getElementsByName("oprocentowanie_stale")[0].value = dane['oprocentowanie_stale'];
        } else {
            document.getElementsByName("oprocentowanie_stale")[0].value = ''
        }



        if ('rodzaj_wiboru' in dane) {
            document.getElementsByName("rodzaj_wiboru")[0].value = dane['rodzaj_wiboru'];
        } else {

            document.getElementsByName("rodzaj_wiboru")[0].value = '3M';
        }



        document.getElementsByName("marza")[0].value = dane['marza'];

        document.getElementsByName("pozaodsetkowe_koszty")[0].value = dane['pozaodsetkowe_koszty'];


    }

    const wynik = JSON.parse({{ wynik_json| tojson | safe}});
    console.log(wynik)



    var zloty = function (d) { return d3.format(",.2f")(d) + " zł"; }


    if (Object.keys(wynik).length > 0) {


        d3.select("section#wynik").classed("is-hidden", false);

        // są wyniki
        console.log('sa wyniki')


        d3.select("span#data_umowy").text(dane['data_umowy'])
        d3.select("span#calkowita_kwota").text(zloty(dane['calkowita_kwota']))
        d3.select("span#kwota_udzielonego").text(zloty(dane['udzielona_kwota']))
        d3.select("span#okresy").text(dane['okresy'])
        d3.select("span#rodzaj_rat").text(function (d) {
            if (dane['rodzaj_rat'] == 'stale') {
                return 'stałe'
            }
            else {
                return 'malejące'
            }

        }
        );


        d3.select("span#rodzaj_oprocentowania").text(function (d) {
            if (dane['oprocentowanie_pozyczki'] == 'stale') {
                return 'stałe'
            }
            else {
                return 'zmienne'
            }

        }
        );




        if ('oprocentowanie_stale' in dane) {
            d3.select("span#oprocentowanie_stale").text(dane['oprocentowanie_stale'] + '%')
        } else {
            d3.select("span#oprocentowanie_stale").text('nie dotyczy')
        }

        if ('rodzaj_wiboru' in dane) {
            d3.select("span#rodzaj_wiboru").text('WIBOR ' + dane['rodzaj_wiboru'])
        }
        else {
            d3.select("span#rodzaj_wiboru").text('nie dotyczy')
        }

        d3.select("span#marza").text(dane['marza'] + '%');

        d3.select("span#pozaodsetkowe_koszty").text(zloty(dane['pozaodsetkowe_koszty']));

        d3.select("span#prowizja").text(zloty(wynik['prowizja']));
        d3.select("span#calkowite_oprocentowanie").text(wynik['stopa']+'%');


        d3.select("p#rrso_bez_p").text(wynik['rrso'] + '%');
        d3.select("p#rrso_z_p").text(wynik['rrso_prowizja'] + '%');




    }






</script>