{% extends 'base.html' %}

{% block content %}
<div class="container">
  <div class="row top-buffer">
    <h1 class="title">Kredyt</h1>
  </div>

  <div class="row top-buffer">
    <!-- <div class="col" id="dane">
        <ul class="list-group list-group-flush">
          <li>Kapitał pożyczony: <div style="float: right" id="kapital"></div>
          </li>
          <li>Marża:<div style="float: right" id="marza"></div>
          </li>
          <li>Okresy:<div style="float: right" id="okresy"></div>
          </li>
          <li>Data uruchomienia:<div style="float: right" id="data_start"></div>
          </li>
          <li>Suma rat:<div style="float: right" id="suma_rat"></div>
          </li>
          <li>Suma nadpłat:<div style="float: right" id="suma_nadplat"></div>
          </li>
          <li>Zapłacono do banku:<div style="float: right" id="suma_cala"></div>
          </li>
        </ul>
      </div>
    </div> -->
    <div class="columns">
      <div class="column">
        <ul class="list-group list-group-flush">
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Kapitał pożyczony</span><span class="tekst" id="kapital"></span></div>
          </li>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Data uruchomienia</span><span class="tekst" id="data_start"></span></div>
          </li>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Marża</span><span class="tekst" id="marza"></span></div>
          </li>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Liczba rat</span><span class="tekst" id="okresy"></span></div>
          </li>
        </ul>
      </div>
      <div class="column">
        <ul>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Wskaźnik</span></span><span class="tekst" id="rodzaj_wiboru_id"></span></div>
          </li>      
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Suma rat</span></span><span class="tekst" id="suma_rat"></span></div>
          </li>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Suma nadpłat</span></span><span class="tekst" id="suma_nadplat"></span></div>
          </li>
          <li><div class="kontainer"><div class="filler"></div><span class="naklejka">Zapłacono do banku</span></span><span class="tekst" id="suma_cala"></span></div>
          </li>
        </ul>
      </div>

    </div>

  </div>






<div class="row top-buffer">
  <div class="col" id="ryswibor">Rys. Wibor 3M. Połączona część rzeczywista z prognozą.</div>
</div>
<div class="row top-buffer">
  <div class="col" id="rysInflacja">Rys.Inflacja M/M. Połączona część rzeczywista z prognozą.</div>
</div>
<div class="row top-buffer">
  <div class="col" id="rysNadplaty">Rys.Nadpłaty - wartości nominalne.</div>
</div>
<div class="row top-buffer">
  <div class="col" id="wykres_kapital">Rys. Kapitał do spłaty (dług) oraz cena kosztowa.</div>
</div>
<div class="row top-buffer">
  <div class="col" id="wykres_real">Rys. Wartości nominalne i realne rat, kosztów skumulowanych, i wartości
    nieruchomości.</div>
</div>
<div class="row top-buffer">
</div>
</div>


</body>

<script type="module">
  import { create_chart_koszty } from "{{url_for('static', filename='chart_koszty.js')}}";
  import { create_chart_kapital } from "{{url_for('static', filename='chart_kapital.js')}}";
  import { create_chart_wibor } from "{{url_for('static', filename='chart_wibor.js')}}";
  import { create_chart_inflacja } from "{{url_for('static', filename='chart_inflacja.js')}}";
  import { create_chart_nadplaty } from "{{url_for('static', filename='chart_nadplaty.js')}}";

  var dane1 = JSON.parse('{{wynik|safe}}');
  var inflacja = JSON.parse('{{inflacja|safe}}');
  var real_koszty = JSON.parse('{{real_koszty|safe}}');
  var nom_koszty = JSON.parse('{{nom_koszty|safe}}');
  var real_raty = JSON.parse('{{real_raty|safe}}');
  var nom_raty = JSON.parse('{{nom_raty|safe}}');
  var nom_kpo = JSON.parse('{{nom_kpo|safe}}');
  var real_kpo = JSON.parse('{{real_kpo|safe}}');
  var nom_kmiesiac = JSON.parse('{{nom_kmiesiac|safe}}');
  var real_kmiesiac = JSON.parse('{{real_kmiesiac|safe}}');
  var real_wartosc_nieruchomosc = JSON.parse('{{real_wartosc_nieruchomosc|safe}}');
  var nom_wartosc_nieruchomosc = JSON.parse('{{nom_wartosc_nieruchomosc|safe}}');
  var wibor_all = JSON.parse('{{wibor|safe}}');
  var fin_data = JSON.parse('{{fin_data|safe}}');

 var wibor = wibor_all['dane']
 var rodzaj_wiboru=wibor_all['rodzaj_wiboru']

  console.log(wibor)
  console.log('kmiesiac')
  console.log(nom_kmiesiac)


  var zloty = function (d) { return d3.format(",.2f")(d) + " zł"; }

  var suma_rat = d3.sum(dane1['raty'], d => d.rata)
  var suma_nadplat = d3.sum(dane1['nadplaty'], d => d.kwota)
  var suma_kapitalow = d3.sum(dane1['raty'], d => d.kapital)


  d3.select("#kapital").text(zloty(fin_data['kapital']))
  d3.select("#okresy").text(fin_data['okresy'])
  d3.select("#marza").text(fin_data['marza'] + '%')
  d3.select("#data_start").text(fin_data['data_start'])
  d3.select("#suma_rat").text(zloty(suma_rat))
  d3.select("#suma_nadplat").text(zloty(suma_nadplat))
  d3.select("#suma_cala").text(zloty(suma_rat + suma_nadplat))
  d3.select("#rodzaj_wiboru_id").text('WIBOR ' + rodzaj_wiboru)




  var width_docs = document.getElementById('ryswibor').clientWidth;

  var margin = { top: 60, right: 30, bottom: 70, left: 80 },
    width = width_docs - margin.left - margin.right,
    height = 450 - margin.top - margin.bottom;


  var parseDateWykres = d3.timeParse("%Y-%m-%d");
  var parseDateRealKPO = d3.timeParse("%Y-%m");


  var dane_wykres = dane1['raty']
  dane_wykres.forEach(function (d) {
    d.dzien = parseDateWykres(d.dzien)
    d.K_po = parseFloat(d.K_po)
    d.rata = parseFloat(d.rata)
  });

  console.log('nom kpo');
  console.log(nom_kpo);

  nom_kpo.forEach(function (d) {
    d.miesiac = d.dzien;
    d.dzien = parseDateRealKPO(d.dzien);
    d.K_po = parseFloat(d.wartosc);
  });

  real_kpo.forEach(function (d) {
    d.dzien = parseDateRealKPO(d.miesiac)
    d.K_po = parseFloat(d.wartosc)
  });

  nom_kmiesiac.forEach(function (d) {
    d.miesiac = d.dzien;
    d.dzien = parseDateRealKPO(d.dzien);
    d.K_po = parseFloat(d.wartosc);
  });

  real_kmiesiac.forEach(function (d) {
    d.dzien = parseDateRealKPO(d.miesiac)
    d.K_po = parseFloat(d.wartosc)
  });



  nom_koszty.sort(function (x, y) {
    return d3.ascending(x.dzien, y.dzien);
  })



  var parseDate = d3.timeParse("%Y-%m");
  var cumsum_nom = 0

  nom_koszty.forEach(function (d) {
    d.huj = d.dzien;
    d.miesiac = parseDate(d.dzien);
    d.wartosc = parseFloat(d.wartosc);
    cumsum_nom = cumsum_nom + d.wartosc;
    d.cumsum_nom = cumsum_nom;

  });

  console.log('nom koszty')
  console.log(nom_koszty)



  const mergedResult = {};


  // Merge arr1
  nom_kmiesiac.forEach(obj => {

    const yearMonth = obj.miesiac; // Extract 'YYYY-MM' from the date

    if (!mergedResult[yearMonth]) {
      mergedResult[yearMonth] = obj.K_po;

    } else {
      mergedResult[yearMonth] += obj.K_po;
    }
  });


  // Merge arr2
  nom_koszty.forEach(obj => {
    const yearMonth = obj.huj

    if (!mergedResult[yearMonth]) {
      mergedResult[yearMonth] = obj.cumsum_nom;
    } else {
      mergedResult[yearMonth] += obj.cumsum_nom;

    }
  });








  const nom_cena_kosztowa = Object.entries(mergedResult).map(([miesiac, wartosc]) => ({ miesiac, wartosc }));
  nom_cena_kosztowa.sort(function (x, y) {
    return d3.ascending(x.miesiac, y.miesiac);
  })



  nom_cena_kosztowa.forEach(function (d) {

    d.miesiac = parseDate(d.miesiac)
    d.wartosc = parseFloat(d.wartosc)


  });



  var parseDate = d3.timeParse("%Y-%m");



  real_koszty.sort(function (x, y) {
    return d3.ascending(x.miesiac, y.miesiac);
  })

  var cumsum = 0;

  real_koszty.forEach(function (d) {
    d.huj = d.miesiac;
    d.miesiac = parseDate(d.miesiac);
    d.wartosc = parseFloat(d.wartosc);
    cumsum = cumsum + d.wartosc;
    d.cumsum = cumsum;

  });




  const mergedResultReal = {};


  // Merge arr1
  real_koszty.forEach(obj => {

    const yearMonth = obj.huj; // Extract 'YYYY-MM' from the date

    if (!mergedResultReal[yearMonth]) {
      mergedResultReal[yearMonth] = obj.cumsum;

    } else {
      mergedResultReal[yearMonth] += obj.cumsum;
    }
  });




  // Merge arr2
  real_kmiesiac.forEach(obj => {
    const yearMonth = obj.miesiac

    if (!mergedResultReal[yearMonth]) {
      mergedResultReal[yearMonth] = obj.K_po;
    } else {
      mergedResultReal[yearMonth] += obj.K_po;

    }
  });



  const real_cena_kosztowa = Object.entries(mergedResultReal).map(([miesiac, wartosc]) => ({ miesiac, wartosc }));

  real_cena_kosztowa.sort(function (x, y) {
    return d3.ascending(x.miesiac, y.miesiac);
  })

  real_cena_kosztowa.forEach(function (d) {

    d.miesiac = parseDate(d.miesiac)
    d.wartosc = parseFloat(d.wartosc)


  });

  console.log(real_cena_kosztowa)





  create_chart_wibor(margin, width, height, wibor);
  create_chart_inflacja(margin, width, height, inflacja);
  create_chart_nadplaty(margin, width, height, dane1['nadplaty']);
  create_chart_kapital(margin, width, height, nom_kpo, nom_cena_kosztowa, real_kpo, real_cena_kosztowa);
  create_chart_koszty(margin, width, 700, real_koszty, nom_koszty, real_raty, nom_raty, real_wartosc_nieruchomosc, nom_wartosc_nieruchomosc);

</script>

{% endblock %}